<!DOCTYPE html>
{% load static %}
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Welcome to the Game</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Protest+Strike&display=swap" />
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
</head>
<body>
    <div class="page-container">
        <header class="header">
            Header
        </header>
        <div class="game-container">
            <aside class="left-bar">
                <div class="LB-Messages">
                    <!-- Messages will be appended here dynamically -->
                </div>
                <div class="LB_Buttons">
                    <button class="play-button">Play</button>
                </div>
            </aside>
            <main class="content">
                <div class="top-bots">
                    <div class="bot2">
                        Bot2
                    </div>
                    <div class="bot-container">
                        <div class="bot1">
                            Bot1
                        </div>
                        <div class="bot3">
                            Bot3
                        </div>
                    </div>
                </div>
                <div class="game-pot">
                    Game Pot
                </div>
                <div class="player">
                    <div class="cards-container" id="player-cards">
                        <!-- Cards will be appended here dynamically -->
                    </div>
                    Player
                </div>
            </main>
        </div>
    </div>
    {% load static %}
    <script>
        var staticUrl = "{% static 'images/cards/Deck1/' %}";
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
    <script>
        const wsUrl = 'ws://' + window.location.host + '/ws/playPoker/';
        const chatSocket = new WebSocket(wsUrl);
        let displayedMessages = [];
        let displayedCardImages = [];
    
        chatSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            if (data.type === 'update_player_info') {
                //const playerInfoContainer = document.getElementById('playerInfo');
                //playerInfoContainer.textContent = JSON.stringify(data.player_info, null, 2);
            } else if (data.type === 'update_messages') {
                const messagesContainer = document.querySelector('.LB-Messages');
                if (messagesContainer) {
                    messagesContainer.innerHTML = ''; // Clear previous messages
                    const messages = data.messages.slice(-20); // Only take the last 20 messages
                    messages.forEach(message => {
                        const messageDiv = document.createElement('div');
                        messageDiv.textContent = message;
                        messagesContainer.appendChild(messageDiv);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    });
                    displayedMessages = messages;
                }
            } else if (data.type === 'update_card_images') {
                const cardsContainer = document.getElementById('player-cards');
                cardsContainer.innerHTML = ''; // Clear previous card images
                data.card_images.forEach((card, index) => {
                    const cardDiv = document.createElement('div');
                    cardDiv.className = 'card';
                    cardDiv.dataset.selected = '0';
                    cardDiv.dataset.order = index;
                    cardDiv.dataset.originalOrder = index;
                    console.log('Card:', card, 'Original Order:', cardDiv.dataset.originalOrder, 'selected:', cardDiv.dataset.selected);
    
                    const button = document.createElement('button');
                    const img = document.createElement('img');
                    img.src = staticUrl + card.trim();
                    img.draggable = true;
                    button.appendChild(img);
                    cardDiv.appendChild(button);
    
                    button.addEventListener('click', function() {
                        cardDiv.classList.toggle('selected');
                        cardDiv.dataset.selected = cardDiv.classList.contains('selected') ? '1' : '0';
                        console.log(generateDiscardString()); // Debug: Log the discard string
                    });
    
                    img.addEventListener('dragstart', function(event) {
                        event.dataTransfer.setData('text/plain', cardDiv.dataset.order);
                    });
    
                    img.addEventListener('touchstart', function(event) {
                        touchStartX = event.touches[0].clientX;
                        touchStartY = event.touches[0].clientY;
                        draggedElement = cardDiv;
                        event.dataTransfer = {}; // Simulate dataTransfer for touch
                        event.dataTransfer.setData = function(type, val) {
                            this[type] = val;
                        };
                        event.dataTransfer.getData = function(type) {
                            return this[type];
                        };
                        event.dataTransfer.setData('text/plain', cardDiv.dataset.order);
                    });
    
                    cardsContainer.addEventListener('dragover', function(event) {
                        event.preventDefault();
                    });
    
                    cardsContainer.addEventListener('touchmove', function(event) {
                        event.preventDefault();
                        const touch = event.touches[0];
                        const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                        const targetCard = targetElement.closest('.card');
                        if (targetCard && draggedElement) {
                            const sourceOrder = draggedElement.dataset.order;
                            const targetOrder = targetCard.dataset.order;
                            const sourceCard = document.querySelector(`.card[data-order="${sourceOrder}"]`);
                            const targetCardElement = document.querySelector(`.card[data-order="${targetOrder}"]`);
    
                            if (sourceCard !== targetCardElement) {
                                const sourceParent = sourceCard.parentNode;
                                const targetParent = targetCardElement.parentNode;
    
                                const sourceNext = sourceCard.nextSibling === targetCardElement ? sourceCard : sourceCard.nextSibling;
                                targetParent.insertBefore(sourceCard, targetCardElement);
                                sourceParent.insertBefore(targetCardElement, sourceNext);
                            }
                        }
                    });
    
                    cardDiv.addEventListener('drop', function(event) {
                        event.preventDefault();
                        const sourceOrder = event.dataTransfer.getData('text/plain');
                        const targetOrder = this.dataset.order;
                        const sourceCard = document.querySelector(`.card[data-order="${sourceOrder}"]`);
                        const targetCard = document.querySelector(`.card[data-order="${targetOrder}"]`);
    
                        if (sourceCard !== targetCard) {
                            const sourceParent = sourceCard.parentNode;
                            const targetParent = targetCard.parentNode;
    
                            const sourceNext = sourceCard.nextSibling === targetCard ? sourceCard : sourceCard.nextSibling;
                            targetParent.insertBefore(sourceCard, targetCard);
                            sourceParent.insertBefore(targetCard, sourceNext);
                        }
                    });
    
                    cardDiv.addEventListener('touchend', function(event) {
                        if (draggedElement) {
                            const touch = event.changedTouches[0];
                            const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
                            const targetCard = targetElement.closest('.card');
                            if (targetCard) {
                                const sourceOrder = draggedElement.dataset.order;
                                const targetOrder = targetCard.dataset.order;
                                const sourceCard = document.querySelector(`.card[data-order="${sourceOrder}"]`);
                                const targetCardElement = document.querySelector(`.card[data-order="${targetOrder}"]`);
    
                                if (sourceCard !== targetCardElement) {
                                    const sourceParent = sourceCard.parentNode;
                                    const targetParent = targetCardElement.parentNode;
    
                                    const sourceNext = sourceCard.nextSibling === targetCardElement ? sourceCard : sourceCard.nextSibling;
                                    targetParent.insertBefore(sourceCard, targetCardElement);
                                    sourceParent.insertBefore(targetCardElement, sourceNext);
                                }
                            }
                            draggedElement = null;
                        }
                    });
    
                    cardsContainer.appendChild(cardDiv);
                });
                displayedCardImages = data.card_images;
            } else if (data.type === 'game_started') {
                alert(data.message);
            }
        };
    
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly');
        };
    
        function generateDiscardString() {
            let discardString = '';
            const cards = document.querySelectorAll('.card');
            cards.forEach(card => {
                discardString += card.dataset.selected;
            });
            return discardString;
        }
    
        document.querySelector('.play-button').addEventListener('click', function() {
            chatSocket.send(JSON.stringify({
                'type': 'start_game'
            }));
        });
    
        document.querySelector('.play-button').addEventListener('touchstart', function() {
            chatSocket.send(JSON.stringify({
                'type': 'start_game'
            }));
        });
    
        function disableButtons() {
            const playButton = document.querySelector('button[name="play"]');
            playButton.disabled = true;
        }
    </script>
</body>
</html>
